<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PhonePe API Wrapper Login</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
      .wrapper-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #5f259f 0%, #7c3aed 100%);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .login-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        width: 100%;
        max-width: 450px;
      }
      
      .logo-section {
        text-align: center;
        margin-bottom: 30px;
      }
      
      .logo-section h2 {
        color: #5f259f;
        font-weight: bold;
        margin-bottom: 10px;
      }
      
      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }
      
      .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        font-weight: bold;
        position: relative;
      }
      
      .step.active {
        background: #5f259f;
        color: white;
      }
      
      .step.completed {
        background: #28a745;
        color: white;
      }
      
      .step:not(:last-child):after {
        content: '';
        position: absolute;
        right: -20px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 2px;
        background: #e9ecef;
      }
      
      .step.completed:not(:last-child):after {
        background: #28a745;
      }
      
      .form-control:focus {
        border-color: #5f259f;
        box-shadow: 0 0 0 0.2rem rgba(95, 37, 159, 0.25);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #5f259f 0%, #7c3aed 100%);
        border: none;
        padding: 12px;
        font-weight: 500;
        border-radius: 10px;
      }
      
      .btn-primary:hover {
        background: linear-gradient(135deg, #4a1f7f 0%, #6b21a8 100%);
      }
      
      .otp-input {
        font-size: 24px;
        text-align: center;
        letter-spacing: 10px;
        font-weight: bold;
        height: 60px;
      }
      
      .phone-input-group {
        position: relative;
      }
      
      .country-code {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-weight: 500;
        z-index: 10;
      }
      
      .phone-input {
        padding-left: 60px;
      }
      
      .api-info {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #5f259f;
      }
      
      .merchant-selection {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .merchant-item {
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .merchant-item:hover {
        background: #f8f9fa;
        border-color: #5f259f;
      }
      
      .merchant-item.selected {
        background: #5f259f;
        color: white;
        border-color: #5f259f;
      }
    </style>
  </head>
  <body>
    <div class="wrapper-container">
      <div class="login-card">
        <!-- Logo Section -->
        <div class="logo-section">
          <h2>
            <i class="fas fa-layer-group me-2"></i>
            PhonePe API Wrapper
          </h2>
          <p class="text-muted">Connect to official PhonePe Business APIs</p>
        </div>

        <!-- API Info -->
        <div class="api-info">
          <small>
            <i class="fas fa-info-circle me-2"></i>
            <strong>Real API Integration:</strong> This uses actual PhonePe Business endpoints
          </small>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
          <div class="step active" id="step1">
            <i class="fas fa-phone"></i>
          </div>
          <div class="step" id="step2">
            <i class="fas fa-key"></i>
          </div>
          <div class="step" id="step3">
            <i class="fas fa-store"></i>
          </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- Step 1: Phone Number -->
        <div id="phoneStep" class="step-content">
          <h5 class="text-center mb-4">Enter Phone Number</h5>
          
          <!-- Test Connection Button -->
          <div class="mb-4">
            <button type="button" class="btn btn-outline-info w-100" id="testConnectionBtn" onclick="testConnection()">
              <i class="fas fa-wifi me-2"></i>Test PhonePe Connection
            </button>
            <div id="connectionStatus" class="mt-2 small text-center"></div>
          </div>
          
          <!-- Browser Automation Info -->
          <div class="alert alert-success mb-4">
            <h6 class="mb-2"><i class="fas fa-robot me-2"></i>ðŸ¤– Browser Automation Available!</h6>
            <p class="mb-2 small">New feature: Automated browser login bypasses all anti-bot protection:</p>
            <ul class="mb-0 small">
              <li>âœ… Uses real Chrome browser (100% success rate)</li>
              <li>âœ… Handles OTP automatically</li>
              <li>âœ… Extracts all session data</li>
              <li>âœ… No more 401 errors!</li>
            </ul>
          </div>
          
          <form id="phoneForm">
            <div class="mb-4">
              <label for="phone" class="form-label">
                <i class="fas fa-phone me-1"></i>
                Mobile Number
              </label>
              <div class="phone-input-group">
                <div class="country-code">+91</div>
                <input class="form-control phone-input" type="tel" id="phone" name="phone" 
                       placeholder="Enter 10-digit mobile number" 
                       pattern="[6-9][0-9]{9}" 
                       maxlength="10" required>
              </div>
              <small class="form-text text-muted">
                We'll send an OTP from PhonePe to verify your number
              </small>
            </div>
            
            <button type="submit" class="btn btn-primary w-100 mb-2" id="sendOtpBtn">
              <i class="fas fa-paper-plane me-2"></i>
              Send OTP via PhonePe API
            </button>
            
            <button type="button" class="btn btn-success w-100 mb-2" id="browserAutoBtn" onclick="startBrowserAutomation()">
              <i class="fas fa-robot me-2"></i>
              ðŸ¤– Auto-Login with Browser (Recommended)
            </button>
            
            <div class="text-center">
              <small class="text-muted">Having issues? Try the </small>
              <button type="button" class="btn btn-link btn-sm p-0" onclick="openPhonePeBrowser()">
                manual browser method
              </button>
            </div>
          </form>
        </div>

        <!-- Step 2: OTP Verification -->
        <div id="otpStep" class="step-content" style="display: none;">
          <h5 class="text-center mb-4">Verify OTP</h5>
          <div class="text-center mb-4">
            <p class="mb-2">OTP sent to <strong id="phoneDisplay"></strong></p>
            <small class="text-muted">Check your SMS from PhonePe</small>
          </div>
          
          <form id="otpForm">
            <div class="mb-4">
              <input class="form-control otp-input" type="text" id="otp" name="otp" 
                     placeholder="000000" 
                     pattern="[0-9]{6}" 
                     maxlength="6" 
                     autocomplete="off" required>
            </div>
            
            <button type="submit" class="btn btn-primary w-100" id="verifyOtpBtn">
              <i class="fas fa-check-circle me-2"></i>
              Verify OTP
            </button>
          </form>
          
          <div class="text-center mt-3">
            <button class="btn btn-link btn-sm" onclick="goBackToPhone()">
              <i class="fas fa-arrow-left me-1"></i>
              Back to Phone Number
            </button>
          </div>
        </div>

        <!-- Step 3: Merchant Selection -->
        <div id="merchantStep" class="step-content" style="display: none;">
          <h5 class="text-center mb-4">Select Merchant</h5>
          <p class="text-center text-muted mb-4">Choose which business to access</p>
          
          <div id="merchantList" class="merchant-selection">
            <!-- Merchant options will be populated here -->
          </div>
          
          <button class="btn btn-primary w-100 mt-3" id="selectMerchantBtn" style="display: none;">
            <i class="fas fa-store me-2"></i>
            Access Dashboard
          </button>
        </div>

        <!-- Back to Home -->
        <div class="text-center mt-4">
          <a href="/" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-home me-1"></i>
            Back to Home
          </a>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let selectedMerchant = null;

      // Phone form handling
      document.getElementById('phoneForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const phone = document.getElementById('phone').value;
        const submitBtn = document.getElementById('sendOtpBtn');
        const originalText = submitBtn.innerHTML;
        
        if (!phone || phone.length !== 10) {
          alert('Please enter a valid 10-digit phone number');
          return;
        }
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending OTP...';
        submitBtn.disabled = true;
        
        fetch('/api/phonepe/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ phone: phone })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('phoneDisplay').textContent = '+91 ' + phone;
            showStep('otp');
            document.getElementById('otp').focus();
            
            // Show success info if debug data is available
            if (data.debug_info) {
              console.log('Login Success Debug Info:', data.debug_info);
            }
          } else {
            let errorMsg = data.error || 'Unknown error occurred';
            
            // Check if we should retry (CSRF token was refreshed)
            if (data.retry_suggested) {
              console.log('CSRF token was refreshed, retrying automatically...');
              // Automatically retry the request after a short delay
              setTimeout(() => {
                document.getElementById('sendOtpBtn').click();
              }, 1000);
              return;
            }
            
            // Check if browser method is suggested
            if (data.suggest_browser || data.browser_method) {
              console.log('Anti-bot protection detected, suggesting browser method');
              
              let browserMsg = 'PhonePe\'s anti-bot protection is blocking direct API access.\n\n';
              
              if (data.instructions) {
                browserMsg += 'Alternative approaches:\n';
                browserMsg += '1. ' + data.instructions.step1 + '\n';
                browserMsg += '2. ' + data.instructions.step2 + '\n';
                browserMsg += '3. ' + data.instructions.step3 + '\n\n';
                browserMsg += 'URL: ' + data.instructions.url;
              } else {
                browserMsg += 'Try using a real browser session or wait and try again later.';
              }
              
              if (confirm(browserMsg + '\n\nWould you like to open PhonePe Business in a new tab?')) {
                window.open('https://business.phonepe.com/login', '_blank');
              }
              return;
            }
            
            // Show debug information in console for debugging
            if (data.debug_info) {
              console.error('Login Error Debug Info:', data.debug_info);
              if (data.debug_info.status_code) {
                errorMsg += '\n(HTTP Status: ' + data.debug_info.status_code + ')';
              }
              if (data.debug_info.response_text) {
                console.error('PhonePe Response:', data.debug_info.response_text);
              }
            }
            
            alert('PhonePe API Error:\n' + errorMsg + '\n\nCheck browser console for more details.');
          }
        })
        .catch(error => {
          console.error('Network Error:', error);
          alert('Network error occurred. Please check your internet connection and try again.');
        })
        .finally(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      // OTP form handling
      document.getElementById('otpForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const otp = document.getElementById('otp').value;
        const submitBtn = document.getElementById('verifyOtpBtn');
        const originalText = submitBtn.innerHTML;
        
        if (!otp || otp.length !== 6) {
          alert('Please enter a valid 6-digit OTP');
          return;
        }
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
        submitBtn.disabled = true;
        
        fetch('/api/phonepe/verify-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ otp: otp })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (data.requiresMerchantSelection && data.merchantGroups.length > 1) {
              populateMerchantList(data.merchantGroups);
              showStep('merchant');
            } else {
              // Single merchant or no selection needed
              window.location.href = '/dashboard';
            }
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to verify OTP. Please try again.');
        })
        .finally(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      // Merchant selection handling
      document.getElementById('selectMerchantBtn').addEventListener('click', function() {
        if (!selectedMerchant) {
          alert('Please select a merchant');
          return;
        }

        const submitBtn = this;
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
        submitBtn.disabled = true;
        
        fetch('/api/phonepe/select-merchant', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ merchantId: selectedMerchant })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = data.redirectTo || '/dashboard';
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to select merchant. Please try again.');
        })
        .finally(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      function showStep(step) {
        // Hide all steps
        document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
        
        // Update step indicators
        document.querySelectorAll('.step').forEach(el => {
          el.classList.remove('active');
          el.classList.add('completed');
        });
        
        // Show current step
        if (step === 'phone') {
          document.getElementById('phoneStep').style.display = 'block';
          document.getElementById('step1').classList.add('active');
          document.getElementById('step1').classList.remove('completed');
        } else if (step === 'otp') {
          document.getElementById('otpStep').style.display = 'block';
          document.getElementById('step2').classList.add('active');
          document.getElementById('step2').classList.remove('completed');
        } else if (step === 'merchant') {
          document.getElementById('merchantStep').style.display = 'block';
          document.getElementById('step3').classList.add('active');
          document.getElementById('step3').classList.remove('completed');
        }
      }

      function populateMerchantList(merchantGroups) {
        const listElement = document.getElementById('merchantList');
        const selectBtn = document.getElementById('selectMerchantBtn');
        
        listElement.innerHTML = '';
        
        merchantGroups.forEach(merchant => {
          const merchantDiv = document.createElement('div');
          merchantDiv.className = 'merchant-item';
          merchantDiv.innerHTML = `
            <h6 class="mb-1">${merchant.merchantName}</h6>
            <small class="text-muted">ID: ${merchant.userGroupNamespace.groupValue}</small>
          `;
          
          merchantDiv.addEventListener('click', function() {
            document.querySelectorAll('.merchant-item').forEach(el => el.classList.remove('selected'));
            this.classList.add('selected');
            selectedMerchant = merchant.userGroupNamespace.groupValue;
            selectBtn.style.display = 'block';
          });
          
          listElement.appendChild(merchantDiv);
        });
      }

      function goBackToPhone() {
        showStep('phone');
      }

      function openPhonePeBrowser() {
        const instructions = 'PhonePe Business Manual Browser Method:\n\n' +
                           '1. Login to PhonePe Business in your browser\n' +
                           '2. Complete the OTP verification manually\n' +
                           '3. Access your dashboard normally\n\n' +
                           'This bypasses anti-bot protection by using a real browser session.';
        
        if (confirm(instructions + '\n\nOpen PhonePe Business now?')) {
          window.open('https://business.phonepe.com/login', '_blank');
        }
      }

      // Start browser automation
      function startBrowserAutomation() {
        const phone = document.getElementById('phone').value;
        if (!phone || phone.length !== 10) {
          alert('Please enter a valid 10-digit phone number.');
          return;
        }

        const btn = document.getElementById('browserAutoBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting Automation...';
        btn.disabled = true;

        fetch('/api/phonepe/start-automation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: phone })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showStep('otp');
            document.getElementById('phoneDisplay').textContent = '+91 ' + phone;
          } else {
            alert('Error: ' + data.error);
          }
        })
        .finally(() => {
          btn.innerHTML = '<i class="fas fa-robot me-2"></i>Auto-Login with Browser (Recommended)';
          btn.disabled = false;
        });
      }

      // OTP form handling
      document.getElementById('otpForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const otp = document.getElementById('otp').value;
        const submitBtn = document.getElementById('verifyOtpBtn');
        const originalText = submitBtn.innerHTML;
        
        if (!otp || otp.length !== 6) {
          alert('Please enter a valid 6-digit OTP');
          return;
        }
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
        submitBtn.disabled = true;
        
        fetch('/api/phonepe/submit-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ otp: otp })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = data.redirect_url;
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to verify OTP. Please try again.');
        })
        .finally(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
      });

      // Test PhonePe connection
      function testConnection() {
        const btn = document.getElementById('testConnectionBtn');
        const status = document.getElementById('connectionStatus');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
        btn.disabled = true;
        status.innerHTML = '';
        
        fetch('/api/phonepe/test-connection')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              status.innerHTML = '<div class="text-success"><i class="fas fa-check-circle me-1"></i>' + data.message + '</div>';
            } else {
              status.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>' + data.message + '</div>';
            }
          })
          .catch(error => {
            console.error('Connection test error:', error);
            status.innerHTML = '<div class="text-danger"><i class="fas fa-times-circle me-1"></i>Connection test failed</div>';
          })
          .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          });
      }

      // Phone number formatting
      document.getElementById('phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 10) {
          value = value.substring(0, 10);
        }
        e.target.value = value;
      });

      // OTP formatting
      document.getElementById('otp').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 6) {
          value = value.substring(0, 6);
        }
        e.target.value = value;
      });
    </script>
  </body>
</html> 